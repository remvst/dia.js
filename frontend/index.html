<!DOCTYPE html>
<html>
	<head>
		<title>Dia.js</title>
		
		<link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css" />
		<link rel="stylesheet" href="css/gui.css" />
		<script src="../bower_components/jquery/dist/jquery.min.js"></script>
		<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="../bower_components/mustache/mustache.js"></script>
		<script src="../dist/dia.js"></script>
		
		
	</head>
	
	<body>
		<nav class="navbar navbar-default">
			<div class="container-fluid">
			  <div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				  <span class="sr-only">Toggle navigation</span>
				  <span class="icon-bar"></span>
				  <span class="icon-bar"></span>
				  <span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Dia.js</a>
			  </div>
			  <div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
				  <li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">File <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					  <li><a href="#">New</a></li>
					  <li><a href="#">Save</a></li>
					  <li><a href="#">Load</a></li>
					</ul>
				  </li>
				  <li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Edit <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					  <li><a href="#">Copy</a></li>
					  <li><a href="#">Cut</a></li>
					  <li><a href="#">Paste</a></li>
					</ul>
				  </li>
				</ul>
			  </div><!--/.nav-collapse -->
			</div><!--/.container-fluid -->
	  	</nav>
		
		<div id="side-panel">
			<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
			  <div class="panel panel-default">
				<div class="panel-heading">
				  <h4 class="panel-title">Toolbox</h4>
				</div>
				<div>
				  <div class="panel-body" id="toolbox">
					  <!-- Generated by the GUI -->
				  </div>
				</div>
			  </div>
			</div>
		</div>
		
		<div id="canvas-container">
			<canvas id="canvas"></canvas>
		</div>
		
		<script>
			var classType = new dia.ElementType({
				id: 'uml.class',
				label: 'Class'
			});
			classType.addProperty(new dia.Property({
				id: 'x',
				type: dia.DataType.INTEGER,
				default: 50,
				private: true
			}));
			classType.addProperty(new dia.Property({
				id: 'y',
				type: dia.DataType.INTEGER,
				default: 100,
				private: true
			}));
			classType.addProperty(new dia.Property({
				id: 'title',
				type: dia.DataType.STRING,
				default: 'class',
				label: 'Class title'
			}));
			classType.addProperty(new dia.Property({
				id: 'attributes',
				type: dia.DataType.STRING_ARRAY,
				default: [],
				label: 'Instance attributes'
			}));
			classType.addProperty(new dia.Property({
				id: 'methods',
				type: dia.DataType.STRING_ARRAY,
				default: [],
				label: 'Instance methods'
			}));
			classType.setRepresentationFactory(function(element){
				var representation = new dia.GraphicalRepresentation(element);

				var lineHeight = 20;
				var padding = 10;

				var getRequiredWidth = function(){
					var maxLength = element.getProperty('title').length;
					element.getProperty('attributes').forEach(function(attr){
						maxLength = Math.max(maxLength, attr.length);
					});
					element.getProperty('methods').forEach(function(attr){
						maxLength = Math.max(maxLength, attr.length);
					});
					return maxLength * 10 + 2 * padding;
				};

				var getRequiredHeight = function(){
					return lineHeight * (1 + Math.max(1, element.getProperty('methods').length)
										 + Math.max(1, element.getProperty('attributes').length));
				};

				representation.addRenderable(new dia.Renderable(function(c){
					c.translate(element.getProperty('x'), element.getProperty('y'));

					var width = getRequiredWidth();
					var height = getRequiredHeight();

					c.fillStyle = '#ffffff';
					c.fillRect(0, 0, width, height);

					c.fillStyle = '#000';

					c.fillRect(0, 0, width, 1);
					c.fillRect(0, height - 1, width, 1);
					c.fillRect(0, lineHeight, width, 1);
					c.fillRect(0, lineHeight * (Math.max(1, element.getProperty('attributes').length) + 1), width, 1);

					c.fillRect(0, 0, 1, height);
					c.fillRect(width - 1, 0, 1, height);

					c.textBaseline = 'middle';
					c.font = '10pt Arial';

					c.textAlign = 'center';
					c.fillText(element.getProperty('title'), width / 2, lineHeight / 2);

					c.textAlign = 'left';

					var y = 1.5 * lineHeight;
					var lines = element.getProperty('attributes').concat(element.getProperty('methods'));
					for(var i = 0 ; i < lines.length ; i++){
						c.fillText(lines[i], padding, y);
						y += lineHeight;
					}
				}));

				var area = new dia.RectangleArea({
					x: function(){ return element.getProperty('x'); },
					y: function(){ return element.getProperty('y'); },
					width: getRequiredWidth,
					height: getRequiredHeight
				});

				var moveHandle = new dia.MoveElementDragHandle(element, area);
				representation.addHandle(moveHandle);
				
				representation.area = area;

				return representation;
			});
			
			classType.creatorTool = new dia.CreateTool({
				type: classType,
				mouseDown: function(sheet, x, y){
					var element = this.type.emptyElement();
					element.setProperty('x', x);
					element.setProperty('y', y);
					sheet.addElement(element);
					
					this.dispatch('elementcreated');
				}
			});
			
			
			// Relation
			var relationType = new dia.ElementType({
				id: 'uml.relation',
				label: 'Relation'
			});
			relationType.addProperty(new dia.Property({
				id: 'from',
				type: dia.DataType.ANCHOR,
				private: true
			}));
			
			relationType.addProperty(new dia.Property({
				id: 'to',
				type: dia.DataType.ANCHOR,
				private: true
			}));
			
			relationType.setRepresentationFactory(function(element){
				var repr = new dia.GraphicalRepresentation(element);
				
				var fromPosition = function(){
					var from = element.getProperty('from');
					var fromRepr = element.sheet.getElement(from.element).getRepresentation();
					
					return {
						x: fromRepr.area.getX() + fromRepr.area.getWidth() * from.x,
						y: fromRepr.area.getY() + fromRepr.area.getHeight() * from.y
					};
				};
				
				var toPosition = function(){
					var to = element.getProperty('to');
					var toRepr = element.sheet.getElement(to.element).getRepresentation();
					
					return {
						x: toRepr.area.getX() + toRepr.area.getWidth() * to.x,
						y: toRepr.area.getY() + toRepr.area.getHeight() * to.y
					};
				};
				
				repr.addRenderable(new dia.Renderable(function(c){
					var fromPos = fromPosition();
					var toPos = toPosition();
					
					var angle = Math.atan2(toPos.y - fromPos.y, toPos.x - fromPos.x);
					var length = dia.distance(fromPos.x, fromPos.y, toPos.x, toPos.y);
					
					c.save();
					c.translate(fromPos.x, fromPos.y);
					c.rotate(angle);
					
					c.beginPath();
					c.moveTo(0, 0);
					c.lineTo(length, 0);
					c.stroke();
					
					c.fillStyle = 'black';
					
					c.beginPath();
					c.moveTo(length, 0);
					c.lineTo(length - 10, 5);
					c.lineTo(length - 10, -5);
					c.fill();
					
					c.restore();
				}));
				
				var areaFrom = new dia.RectangleArea({
					x: function(){ return fromPosition().x - 10 },
					y: function(){ return fromPosition().y - 10 },
					width: function(){ return 20; },
					height: function(){ return 20; }
				});
				
				var areaTo = new dia.RectangleArea({
					x: function(){ return toPosition().x - 5 },
					y: function(){ return toPosition().y - 5 },
					width: function(){ return 10; },
					height: function(){ return 10; }
				});

				var fromHandle = new dia.MoveAnchorDragHandle(element, areaFrom, 'from');
				repr.addHandle(fromHandle);

				var toHandle = new dia.MoveAnchorDragHandle(element, areaTo, 'to');
				repr.addHandle(toHandle);
				
				repr.area = new dia.LineArea({
					x1: function(){ return fromPosition().x; },
					y1: function(){ return fromPosition().y; },
					x2: function(){ return toPosition().x; },
					y2: function(){ return toPosition().y; }
				});
				
				var tmpHandle = new dia.DragHandle(element, repr.area);
				repr.addHandle(tmpHandle);
				
				return repr;
			});
			
			var elementThatContains = function(sheet, x, y){
				var area;
				for(var i = 0 ; i < sheet.elements.length ; i++){
					area = sheet.elements[i].getRepresentation().area;
					if(area && area.contains(x, y)){
						return sheet.elements[i];
					}
				}
				return null;
			};
			
			relationType.creatorTool = new dia.CreateTool({
				type: relationType,
				mouseDown: function(sheet, x, y){
					this.from = elementThatContains(sheet, x, y);
				},
				mouseUp: function(sheet, x, y){
					var to = elementThatContains(sheet, x, y);
					if(to && this.from && to !== this.from){
						var element = this.type.create({
							from: {
								element: this.from.id,
								x: 0,
								y: 0
							},
							to: {
								element: to.id,
								x: 0,
								y: 0
							}
						});
						
						sheet.addElement(element);
						
						this.dispatch('elementcreated');
					}
					
					this.from = null;
				}
			});
			
			// Broken relation type
			var brokenType = new dia.ElementType({
				id: 'uml.broken',
				label: 'Broken line'
			});
			brokenType.addProperty(new dia.Property({
				id: 'from',
				type: dia.DataType.ANCHOR,
				private: true
			}));
			brokenType.addProperty(new dia.Property({
				id: 'to',
				type: dia.DataType.ANCHOR,
				private: true
			}));
			brokenType.addProperty(new dia.Property({
				id: 'points',
				type: dia.DataType.ANY,
				private: true,
				default: []
			}));
			
			brokenType.setRepresentationFactory(function(element){
				var repr = new dia.GraphicalRepresentation(element);
				
				var fromPosition = function(){
					var from = element.getProperty('from');
					var fromRepr = element.sheet.getElement(from.element).getRepresentation();
					
					return {
						x: fromRepr.area.getX() + fromRepr.area.getWidth() * from.x,
						y: fromRepr.area.getY() + fromRepr.area.getHeight() * from.y
					};
				};
				
				var toPosition = function(){
					var to = element.getProperty('to');
					var toRepr = element.sheet.getElement(to.element).getRepresentation();
					
					return {
						x: toRepr.area.getX() + toRepr.area.getWidth() * to.x,
						y: toRepr.area.getY() + toRepr.area.getHeight() * to.y
					};
				};
				
				repr.addRenderable(new dia.Renderable(function(c){
					var fromPos = fromPosition();
					var toPos = toPosition();
					
					c.beginPath();
					c.moveTo(fromPos.x, fromPos.y);
					
					var points = element.getProperty('points');
					for(var i = 0 ; i < points.length ; i++){
						c.lineTo(points[i].x, points[i].y);
					}
					
					c.lineTo(toPos.x, toPos.y);
					c.stroke();
				}));
				
				repr.area = new dia.BrokenLineArea({
					points: function(){
						var from = fromPosition();
						var to = toPosition();
						
						return [from].concat(element.getProperty('points')).concat([to]);
					}
				});
				
				var handle = new dia.BrokenLineDragHandle(element, repr.area, 'points');
				repr.addHandle(handle);
				
				return repr;
			});
			
			brokenType.creatorTool = new dia.CreateTool({
				type: brokenType,
				mouseDown: function(sheet, x, y){
					this.from = elementThatContains(sheet, x, y);
				},
				mouseUp: function(sheet, x, y){
					var to = elementThatContains(sheet, x, y);
					if(to && this.from && to !== this.from){
						var element = this.type.create({
							from: {
								element: this.from.id,
								x: 0,
								y: 0
							},
							to: {
								element: to.id,
								x: 0,
								y: 0
							},
							//points : [{x: 0, y: 0}]
						});
						
						sheet.addElement(element);
						
						this.dispatch('elementcreated');
					}
					
					this.from = null;
				}
			});
			
			var app = new dia.App();
			app.sheet = dia.Sheet.fromJSON({"title":null,"elements":[{"type":"uml.class","id":"b2bbcc25-84c9-4d4a-be5d-2a70281eb6d5","properties":{"x":354,"y":191,"title":"class","attributes":[],"methods":[]}},{"type":"uml.class","id":"ba7af3d5-949b-40e9-b64a-6e8ed71c556d","properties":{"x":697,"y":198,"title":"class","attributes":[],"methods":[]}},{"type":"uml.relation","id":"4c37d5bd-faf8-4ccc-ac9a-03e8ef1183b1","properties":{"from":{"element":"b2bbcc25-84c9-4d4a-be5d-2a70281eb6d5","x":0,"y":0},"to":{"element":"ba7af3d5-949b-40e9-b64a-6e8ed71c556d","x":0,"y":0.8666666666666667}}}]});
			app.start();
		</script>
	</body>
</html>
